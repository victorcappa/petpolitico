using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class SistemaBatalhas : MonoBehaviour
{
    public GameObject canvasBatalhas;
    public BattleStates currentState;
    public TipoBatalha tipoDessaBatalha;

    float ataque = 20;
    // public float popularidade;
    public float popularidadePlayer;

    public float maxPopInimigo;
    public float popularidadeInimigo;

    bool playerAtacou, inimigoAtacou;
    public Text popInimigo_txtUI, pop_txtUI;
    public Slider barraPopInimigo, barraPop;
    public bool trocouPersonagem, trocouInimigo;

    public int quantosInimigos;

    public Button botao1, botao2;

    public float somaPopPartido;

    public GameObject painelPartido, fecharPainel;


    public List<float> popPersonagens = new List<float>();
    public float popLula, popCiro, popBolso, popDilma, popSuplicy, popEneas;
    public Button LulaPartido, CiroPartido, BolsoPartido, DilmaPartido, SuplicyPartido, EneasPartido;
    public List<Button> meuPartido = new List<Button>();


    public enum BattleStates
    {
        START,
        ESCOLHAJOGADOR,
        ESCOLHAINIMIGO,
        PERDEU,
        GANHOU
    }

    public enum TipoBatalha
    {
        ELEICAO,
        IMPEACHMENT,
        MILITANTES,
        LAVAJATO
    }



    private void Awake()
    {
        popularidadePlayer = PlayerPrefs.GetFloat("PopularidadeNaScene");
        pop_txtUI.text = Mathf.Round(popularidadePlayer).ToString();
        barraPop.value = popularidadePlayer;
        barraPop.maxValue = 100;

        SomaPartido();

    }



    void Start()
    {

        quantosInimigos = PlayerPrefs.GetInt("QuantosInimigos");
        PlayerPrefs.SetFloat("QuantosInimigos", quantosInimigos);

        popInimigo_txtUI.text = popularidadeInimigo.ToString();
        barraPopInimigo.value = popularidadeInimigo;
        barraPopInimigo.maxValue = 100;

        popularidadeInimigo = PlayerPrefs.GetFloat("PopInimigos");
        PlayerPrefs.SetFloat("PopInimigos", popularidadeInimigo);


        FluxoBatalha();



        popularidadePlayer = PlayerPrefs.GetFloat("PopularidadeNaScene");
        pop_txtUI.text = Mathf.Round(popularidadePlayer).ToString();
        barraPop.value = popularidadePlayer;
        barraPop.maxValue = 100;

        currentState = BattleStates.START;

    } // FIM START


    void Update()
    {
        print(somaPopPartido);
       //print("Partido " +  quantosPartido);
        pop_txtUI.text = Mathf.Round(popularidadePlayer).ToString();
        barraPop.value = popularidadePlayer;



        FluxoBatalha();

    } // FIM UPDATE

    public void FluxoBatalha()
    {
        PlayerPrefs.SetInt("NaBatalha", 1);

        popularidadeInimigo = PlayerPrefs.GetFloat("PopInimigos");
        PlayerPrefs.SetFloat("PopInimigos", popularidadeInimigo);
        quantosInimigos = PlayerPrefs.GetInt("QuantosInimigos");

        PlayerPrefs.SetInt("QuantosInimigos", quantosInimigos);


        popInimigo_txtUI.text = popularidadeInimigo.ToString();
        barraPopInimigo.value = popularidadeInimigo;

        pop_txtUI.text = Mathf.Round(popularidadePlayer).ToString();
        barraPop.value = popularidadePlayer;


        Debug.Log(currentState);



        switch (currentState)
        {
            case BattleStates.START:
                HabilitaBotoes();

                popularidadeInimigo = PlayerPrefs.GetFloat("PopInimigos");

                print("Pop Inimigos" + PlayerPrefs.GetFloat("PopInimigos"));

                PopPersonagens();

                currentState = BattleStates.ESCOLHAJOGADOR;
                break;

            case BattleStates.ESCOLHAJOGADOR:


                if (playerAtacou == true)
                {
                    VerificaHpPlayer();
                    playerAtacou = false;


                }
                if (trocouPersonagem == true)
                {
                  
                    VerificaHpPlayer();
                    trocouPersonagem = false;

                }
                break;

            case BattleStates.ESCOLHAINIMIGO:
                AtaqueInimigo();

                if (inimigoAtacou == true)
                {
                    VerificaHpInimigo();
                    inimigoAtacou = false;
                }
                if (trocouInimigo == true)
                {
                    VerificaHpInimigo();
                    trocouInimigo = false;
                    
                }


                break;

            case BattleStates.PERDEU:
                print("você perdeu");
                PlayerPrefs.SetInt("NaBatalha", 0);
                DesabilitaBotoes();

                break;

            case BattleStates.GANHOU:
                print("você ganhou");
                PlayerPrefs.SetInt("NaBatalha", 0);
                DesabilitaBotoes();

                break;

        }
    }

    public void Inicia()
    {
        currentState = BattleStates.START;
    }

    public void AtaqueJogador()
    {
        ataque = 20;
        if (popularidadeInimigo >= ataque)
        {
            
            print("inimigo perdeu 20 de hp");
            popularidadeInimigo = popularidadeInimigo - ataque;

            PlayerPrefs.SetFloat("PopInimigos", popularidadeInimigo);
            popularidadeInimigo = PlayerPrefs.GetFloat("PopInimigos"); //

            popInimigo_txtUI.text = popularidadeInimigo.ToString();
            barraPopInimigo.value = popularidadeInimigo;

            pop_txtUI.text = Mathf.Round(popularidadePlayer).ToString();
            barraPop.value = popularidadePlayer;


            DesabilitaBotoes();

            playerAtacou = true;
            print("player atacou 1");

        }

        if (popularidadeInimigo < ataque && playerAtacou == false)
        {
            ataque = popularidadeInimigo;
            print("inimigo perdeu " + popularidadeInimigo + " de hp");
            popularidadeInimigo = popularidadeInimigo - ataque;

            PlayerPrefs.SetFloat("PopInimigos", popularidadeInimigo);
            popularidadeInimigo = PlayerPrefs.GetFloat("PopInimigos"); //

            popInimigo_txtUI.text = popularidadeInimigo.ToString();
            barraPopInimigo.value = popularidadeInimigo;

            pop_txtUI.text = Mathf.Round(popularidadePlayer).ToString();
            barraPop.value = popularidadePlayer;


            DesabilitaBotoes();

            playerAtacou = true;
            print("player atacou 2");
        }
      

        // popularidadePlayer = PlayerPrefs.GetFloat("PopularidaNaScene");


    }

    public void AtaqueInimigo()
    {
        //ataque = 20;

        if (popularidadePlayer <= 0)
        {
            popularidadePlayer = 0;
        }
     
        if ( popularidadePlayer >= ataque)
        {
            ataque = 20;

            print("Jogador perdeu 20 de hp");
            popularidadePlayer = popularidadePlayer - ataque;
            somaPopPartido = somaPopPartido - ataque;


            AtualizaPopPersonagens();

            popInimigo_txtUI.text = popularidadeInimigo.ToString();
            barraPopInimigo.value = popularidadeInimigo;

            pop_txtUI.text = Mathf.Round(popularidadePlayer).ToString();
            barraPop.value = popularidadePlayer;



            HabilitaBotoes();

            inimigoAtacou = true;

            print("atacou 1");

                
        }
        if (popularidadePlayer < ataque && inimigoAtacou == false)
        {
            ataque = (int)Mathf.Round(popularidadePlayer);

            print("Jogador perdeu " + popularidadePlayer +  " de hp");
            popularidadePlayer = popularidadePlayer - ataque;
            somaPopPartido = somaPopPartido - ataque;


            AtualizaPopPersonagens();

            popInimigo_txtUI.text = popularidadeInimigo.ToString();
            barraPopInimigo.value = popularidadeInimigo;

            pop_txtUI.text = Mathf.Round(popularidadePlayer).ToString();
            barraPop.value = popularidadePlayer;



            HabilitaBotoes();

            inimigoAtacou = true;
            print("atacou 2");


        }




    } // FIM ATAQUE INIMIGO



    void VerificaHpPlayer()
    {
      

        if (popularidadePlayer < 0)
        {
            popularidadePlayer = 0;
        }

        PlayerPrefs.SetFloat("PopInimigos", popularidadeInimigo);

      


        if (popularidadePlayer > 0 && popularidadeInimigo > 0)
        {
            StartCoroutine(VezInimigo());


        }
        if (popularidadePlayer <= 0)
        {
            // abre painel para trocar de personagem
            painelPartido.gameObject.SetActive(true);
            fecharPainel.gameObject.SetActive(true);
        
            if (somaPopPartido <= 0)
            {
                currentState = BattleStates.PERDEU;

            }



        }


        if (popularidadeInimigo <= 0 && PlayerPrefs.GetInt("PrimeiraVez") == 0)
        {
            quantosInimigos = PlayerPrefs.GetInt("QuantosInimigos") - 1;
            PlayerPrefs.SetInt("QuantosInimigos", quantosInimigos);
            print("trocou inimigo");

            trocouInimigo = true;
            print("quanto enemy " + PlayerPrefs.GetInt("QuantosInimigos"));
            HabilitaBotoes();

            if (quantosInimigos == 0)
            {

                currentState = BattleStates.GANHOU;

            }

        }
    } 

    void VerificaHpInimigo()
    {


        AtualizaPopPersonagens();


        if (popularidadePlayer > 0 && popularidadeInimigo > 0)
        {

            currentState = BattleStates.ESCOLHAJOGADOR;




        }
        if (popularidadePlayer <= 0)
        {
            // abre painel para trocar de personagem
            currentState = BattleStates.ESCOLHAJOGADOR;

            painelPartido.gameObject.SetActive(true);
            fecharPainel.gameObject.SetActive(true);
         

            if ( somaPopPartido <= 0)
            {
                currentState = BattleStates.PERDEU;

            }

        }

        if (popularidadeInimigo <= 0 && PlayerPrefs.GetInt("PrimeiraVez") == 0)
        {
            quantosInimigos = PlayerPrefs.GetInt("QuantosInimigos") - 1;
            PlayerPrefs.SetInt("QuantosInimigos", quantosInimigos);
            print("trocou inimigo");
            barraPopInimigo.value = popularidadeInimigo;
            print("quanto enemy " + PlayerPrefs.GetInt("QuantosInimigos"));

            trocouInimigo = true;
            HabilitaBotoes();

            if (quantosInimigos == 0)
            {
                currentState = BattleStates.GANHOU;

            }


        }


    }



    public void TrocouDePersonagem()
    {
        trocouPersonagem = true;

        PopPersonagens();

        pop_txtUI.text = Mathf.Round(popularidadePlayer).ToString();
        barraPop.value = popularidadePlayer;
        barraPop.maxValue = 100;
        painelPartido.gameObject.SetActive(false);
        fecharPainel.gameObject.SetActive(false);

        DesabilitaBotoes();

    }

    IEnumerator VezInimigo()
    {

        yield return new WaitForSeconds(2f);

        currentState = BattleStates.ESCOLHAINIMIGO;
        print(currentState);
 
    }

    public void DesabilitaBotoes()
    {
        botao1.interactable = false;
        botao2.interactable = false;
    }
    public void HabilitaBotoes()
    {
        botao1.interactable = true;
        botao2.interactable = true;
    }


    //PARA VERIFICAR SE ACABOU A POPULARIDADE DE TODOS DENTRO DO PARTIDO
    public void SomaPartido()
    {
       // quantosPartido = meuPartido.Count;


        if (PlayerPrefs.GetInt("LulaDentroPartido") == 1)
        {
            somaPopPartido = somaPopPartido + PlayerPrefs.GetFloat("PopularidadeLula");
            //meuPartido.Add(LulaPartido);

        }

        if (PlayerPrefs.GetInt("CiroDentroPartido") == 1)
        {
             somaPopPartido = somaPopPartido + PlayerPrefs.GetFloat("PopularidadeCiro");
            //meuPartido.Add(CiroPartido);

        }
        if (PlayerPrefs.GetInt("BolsoDentroPartido") == 1)
        {
            somaPopPartido = somaPopPartido + PlayerPrefs.GetFloat("PopularidadeBolso");
           // meuPartido.Add(BolsoPartido);
        }
        if (PlayerPrefs.GetInt("DilmaDentroPartido") == 1)
        {
            somaPopPartido = somaPopPartido + PlayerPrefs.GetFloat("PopularidadeDilma");

        }
        if (PlayerPrefs.GetInt("SuplicyDentroPartido") == 1)
        {
            somaPopPartido = somaPopPartido + PlayerPrefs.GetFloat("PopularidadeSuplicy");

        }
        if (PlayerPrefs.GetInt("EneasDentroPartido") == 1)
        {
            somaPopPartido = somaPopPartido + PlayerPrefs.GetFloat("PopularidadeEneas");

        }

        print(somaPopPartido);
    }

    public void PopPersonagens()
    {
        if (PlayerPrefs.GetInt("LulaDentroScene") == 1)
        {
            popularidadePlayer = Mathf.Round(PlayerPrefs.GetFloat("PopularidadeLula"));
        }

        if (PlayerPrefs.GetInt("CiroDentroScene") == 1)
        {
            popularidadePlayer = Mathf.Round(PlayerPrefs.GetFloat("PopularidadeCiro"));
        }
        if (PlayerPrefs.GetInt("BolsoDentroScene") == 1)
        {
            popularidadePlayer = Mathf.Round(PlayerPrefs.GetFloat("PopularidadeBolso"));
        }
        if (PlayerPrefs.GetInt("DilmaDentroScene") == 1)
        {
            popularidadePlayer = Mathf.Round(PlayerPrefs.GetFloat("PopularidadeDilma"));
        }
        if (PlayerPrefs.GetInt("SuplicyDentroScene") == 1)
        {
            popularidadePlayer = Mathf.Round(PlayerPrefs.GetFloat("PopularidadeSuplicy"));
        }
        if (PlayerPrefs.GetInt("EneasDentroScene") == 1)
        {
            popularidadePlayer = Mathf.Round(PlayerPrefs.GetFloat("PopularidadeEneas"));
        }
    }

    public void AtualizaPopPersonagens()
    {
        if (PlayerPrefs.GetInt("LulaDentroScene") == 1)
        {
            PlayerPrefs.SetFloat("PopularidadeLula", popularidadePlayer);
            if (PlayerPrefs.GetFloat("PopularidadeLula") <= 0)
            {
                LulaPartido.interactable = false;
            }
        }

        if (PlayerPrefs.GetInt("CiroDentroScene") == 1)
        {
            PlayerPrefs.SetFloat("PopularidadeCiro", popularidadePlayer);
            if (PlayerPrefs.GetFloat("PopularidadeCiro") <= 0)
            {
                CiroPartido.interactable = false;
            }
        }
        if (PlayerPrefs.GetInt("BolsoDentroScene") == 1)
        {
            PlayerPrefs.SetFloat("PopularidadeBolso",popularidadePlayer);
            if (PlayerPrefs.GetFloat("PopularidadeBolso") <= 0)
            {
                BolsoPartido.interactable = false;
            }
        }
        if (PlayerPrefs.GetInt("DilmaDentroScene") == 1)
        {
            PlayerPrefs.SetFloat("PopularidadeDilma", popularidadePlayer);
            if (PlayerPrefs.GetFloat("PopularidadeDilma") <= 0)
            {
                DilmaPartido.interactable = false;
            }
        }
        if (PlayerPrefs.GetInt("SuplicyDentroScene") == 1)
        {
            PlayerPrefs.SetFloat("PopularidadeSuplicy", popularidadePlayer);
            if (PlayerPrefs.GetFloat("PopularidadeSuplicy") <= 0)
            {
                SuplicyPartido.interactable = false;
            }
        }
        if (PlayerPrefs.GetInt("EneasDentroScene") == 1)
        {
            PlayerPrefs.SetFloat("PopularidadeEneas", popularidadePlayer);
            if (PlayerPrefs.GetFloat("PopularidadeEneas") <= 0)
            {
                EneasPartido.interactable = false;
            }
        }
    }


} // FIM DA CLASSE
