using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class SistemaBatalhas : MonoBehaviour
{
    public GameObject canvasBatalhas;
    public BattleStates currentState;
    public TipoBatalha tipoDessaBatalha;

    int ataque = 10;
   // public float popularidade;
    public float popularidadePlayer;

    public float maxPopInimigo;
    public float popularidadeInimigo;

    bool playerAtacou, inimigoAtacou;
    public Text popInimigo_txtUI, pop_txtUI;
    public Slider barraPopInimigo, barraPop;
    public bool trocouPersonagem;

    public int quantosInimigos;


    public enum BattleStates
    {
        START,
        ESCOLHAJOGADOR,
        ESCOLHAINIMIGO,
        PERDEU,
        GANHOU
    }

    public enum TipoBatalha
    {
        ELEICAO,
        IMPEACHMENT,
        MILITANTES,
        LAVAJATO
    }
  


      

  

    // Use this for initialization
    void Start()
    {
        PlayerPrefs.SetInt("NaBatalha", 1); // para parar a velo perda pop e ficha
     

        quantosInimigos = PlayerPrefs.GetInt("QuantosInimigos");
        PlayerPrefs.SetFloat("QuantosInimigos", quantosInimigos);

        popInimigo_txtUI.text = popularidadeInimigo.ToString();
        barraPopInimigo.value = popularidadeInimigo;
        barraPopInimigo.maxValue = PlayerPrefs.GetFloat("PopInimigos");

        popularidadeInimigo = PlayerPrefs.GetFloat("PopInimigos");
        PlayerPrefs.SetFloat("PopInimigos", popularidadeInimigo); 


        FluxoBatalha();

        popularidadePlayer = PlayerPrefs.GetFloat("PopularidaNaScene");
        PlayerPrefs.SetFloat("PopularidadeNaScene", popularidadePlayer);

        pop_txtUI.text = popularidadePlayer.ToString();
        barraPop.value = popularidadePlayer;
        barraPop.maxValue = PlayerPrefs.GetFloat("PopularidaNaScene");

        currentState = BattleStates.START;

    }
    // Update is called once per frame
    void Update()
    {
        pop_txtUI.text = popularidadePlayer.ToString();
        barraPop.value = popularidadePlayer;


        FluxoBatalha();

    } // fim update

    public void FluxoBatalha()
    {
        popularidadeInimigo = PlayerPrefs.GetFloat("PopInimigos");
        PlayerPrefs.SetFloat("PopInimigos", popularidadeInimigo); 
        PlayerPrefs.SetInt("QuantosInimigos", quantosInimigos);
     
        popInimigo_txtUI.text = popularidadeInimigo.ToString();
        barraPopInimigo.value = popularidadeInimigo;

        //popularidadePlayer = PlayerPrefs.GetFloat("PopularidaNaScene");
        //PlayerPrefs.SetFloat("PopularidadeNaScene", popularidadePlayer);

        pop_txtUI.text = popularidadePlayer.ToString();
        barraPop.value = popularidadePlayer;

        Debug.Log(currentState);

       

        switch (currentState)
        {
            case BattleStates.START:
                popularidadeInimigo = PlayerPrefs.GetFloat("PopInimigos");
                popularidadePlayer = PlayerPrefs.GetFloat("PopularidaNaScene");
                print(PlayerPrefs.GetFloat("PopInimigos"));

                currentState = BattleStates.ESCOLHAJOGADOR;
                break;

            case BattleStates.ESCOLHAJOGADOR:
                if (playerAtacou == true)
                {
                    VerificaHpPlayer();
                    playerAtacou = false;
                }
                if (trocouPersonagem == true)
                {
                    VerificaHpPlayer();
                    trocouPersonagem = false;
                }
                break;

            case BattleStates.ESCOLHAINIMIGO:

                AtaqueInimigo();
                if (inimigoAtacou == true)
                {
                    VerificaHpInimigo();
                    inimigoAtacou = false;
                }


                break;

            case BattleStates.PERDEU:
                print("você perdeu");
                PlayerPrefs.SetInt("NaBatalha", 0);

                break;

            case BattleStates.GANHOU:
                print("você ganhou");
                PlayerPrefs.SetInt("NaBatalha", 0);

                break;

        }
    }

    public void Inicia()
    {
        currentState = BattleStates.START;
    }

    public void AtaqueJogador()
    {
        


        print("inimigo perdeu 10 de hp");
        popularidadeInimigo = popularidadeInimigo - ataque;

        PlayerPrefs.SetFloat("PopInimigos", popularidadeInimigo);
        popularidadeInimigo = PlayerPrefs.GetFloat("PopInimigos"); //

        popInimigo_txtUI.text = popularidadeInimigo.ToString();
        barraPopInimigo.value = popularidadeInimigo;

        pop_txtUI.text = popularidadePlayer.ToString();
        barraPop.value = popularidadePlayer;

        playerAtacou = true;

       // popularidadePlayer = PlayerPrefs.GetFloat("PopularidaNaScene");
        PlayerPrefs.SetFloat("PopularidadeNaScene", popularidadePlayer);
       
    }

    public void AtaqueInimigo()
    {
      

        print("Jogador perdeu 10 de hp");
        popularidadePlayer = popularidadePlayer - 5;
        inimigoAtacou = true;

        popInimigo_txtUI.text = popularidadeInimigo.ToString();
        barraPopInimigo.value = popularidadeInimigo;

        pop_txtUI.text = popularidadePlayer.ToString();
        barraPop.value = popularidadePlayer;

       // popularidadePlayer = PlayerPrefs.GetFloat("PopularidaNaScene");
        PlayerPrefs.SetFloat("PopularidadeNaScene", popularidadePlayer);
    }



    void VerificaHpPlayer()
    {

        PlayerPrefs.SetFloat("PopularidadeNaScene", popularidadePlayer);
        PlayerPrefs.SetFloat("PopInimigos", popularidadeInimigo); //

       


        if (popularidadePlayer > 0 && popularidadeInimigo > 0)
        {

            currentState = BattleStates.ESCOLHAINIMIGO;
        }
        if (popularidadePlayer <= 0 )
        {

            currentState = BattleStates.PERDEU;

        }
       

        if (popularidadeInimigo <= 0 && PlayerPrefs.GetInt("PrimeiraVez") == 0)
        {
            quantosInimigos = PlayerPrefs.GetInt("QuantosInimigos") - 1;
            PlayerPrefs.SetInt("QuantosInimigos", quantosInimigos);
            // quantosInimigos = PlayerPrefs.GetInt("QuantosInimigos");
            print("trocou inimigo");

            if (quantosInimigos == 0)
            {

                currentState = BattleStates.GANHOU;

            }

        }
    }

    void VerificaHpInimigo()
    {
  


        if (popularidadePlayer > 0 && popularidadeInimigo > 0)
        {

            currentState = BattleStates.ESCOLHAJOGADOR;



        }
        if (popularidadePlayer <= 0)
        {

            currentState = BattleStates.PERDEU;

        }

        if (popularidadeInimigo <= 0 && PlayerPrefs.GetInt("PrimeiraVez") == 0)
        {
            quantosInimigos = PlayerPrefs.GetInt("QuantosInimigos") - 1;
            PlayerPrefs.SetInt("QuantosInimigos", quantosInimigos);
            // quantosInimigos = PlayerPrefs.GetInt("QuantosInimigos");
            print("trocou inimigo");
            barraPopInimigo.value = popularidadeInimigo;


            if (quantosInimigos == 0)
            {

                currentState = BattleStates.GANHOU;

            }


        }

       

    }



   public void TrocouDePersonagem()
    {
        trocouPersonagem = true;

        popularidadePlayer = PlayerPrefs.GetFloat("PopularidaNaScene");
        PlayerPrefs.SetFloat("PopularidadeNaScene", popularidadePlayer);
    }




} // FIM DA CLASSE
